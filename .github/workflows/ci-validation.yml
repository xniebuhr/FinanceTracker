name: CI - Validation

# Runs on every push to any branch
on:
  push:
    branches: ['**']
  workflow_call:  # Allows PR workflow to reuse this

jobs:
  # SECRET SCANNING - Trufflehog
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history

      - name: Run Trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified
      
      - name: Upload Trufflehog Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: trufflehog-results.json

  # CODE QUALITY - Backend Unit Tests
  backend-tests:
    name: Backend Tests (.NET)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Restore Dependencies
        working-directory: ./finance_tracker.backend
        run: dotnet restore
      
      - name: Run xUnit Tests
        working-directory: ./finance_tracker.backend
        # PLACEHOLDER: dotnet test with coverage
        run: echo "xUnit tests placeholder"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: finance_tracker.backend/TestResults/

  # CODE QUALITY - Frontend Unit Tests
  #frontend-tests:
  #  name: Frontend Tests (Angular)
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Checkout code
  #      uses: actions/checkout@v4
  #    
  #    - name: Setup Node.js
  #      uses: actions/setup-node@v4
  #      with:
  #        node-version: '20.x'
  #    
  #    - name: Install Dependencies
  #      working-directory: ./finance_tracker.frontend
  #      run: npm ci
  #    
  #    - name: Run Karma Tests
  #      working-directory: ./finance_tracker.frontend
  #      # PLACEHOLDER: ng test with coverage
  #      run: echo "Karma tests placeholder"
  #    
  #    - name: Upload Test Results
  #      if: always()
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: frontend-test-results
  #        path: finance_tracker.frontend/coverage/

  # STATIC APPLICATION SECURITY TESTING - CodeQL
  sast-codeql:
    name: SAST - CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp, javascript
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Build Backend
        working-directory: ./finance_tracker.backend
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # LINTING - Code Style Checks
  lint-backend:
    name: Lint - .NET
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Check Code Formatting
        working-directory: ./finance_tracker.backend
        run: dotnet format --verify-no-changes --verbosity diagnostic

  #lint-frontend:
  #  name: Lint - Angular
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Checkout code
  #      uses: actions/checkout@v4
  #    
  #    - name: Setup Node.js
  #      uses: actions/setup-node@v4
  #      with:
  #        node-version: '20.x'
  #    
  #    - name: Install Dependencies
  #      working-directory: ./finance_tracker.frontend
  #      run: npm ci
  #    
  #    - name: Run ESLint
  #      working-directory: ./finance_tracker.frontend
  #      # PLACEHOLDER: npm run lint
  #      run: echo "ESLint placeholder"

  # DEPENDENCY SCANNING - GitHub Dependabot
  dependency-check:
    name: Dependency Scanning - Dependabot Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for Dependabot Alerts (.NET)
        working-directory: ./finance_tracker.backend
        run: dotnet list package --vulnerable --include-transitive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Dependencies (Angular)
        working-directory: ./finance_tracker.frontend
        run: npm ci

      - name: Check for Dependabot Alerts (Angular)
        working-directory: ./finance_tracker.frontend
        run: npm audit  

  # INFRASTRUCTURE VALIDATION - Terraform
  terraform-validation:
    name: Infrastructure Validation - Terraform
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    defaults:
      run:
        working-directory: ./terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform 
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Terraform Format Check
        run: terraform fmt -check
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Validate
        run: terraform validate

  # INFRASTRUCTURE SECURITY SCANNING - Trivy on Terraform
  terraform-security-scan:
    name: Infrastructure Security - Trivy (Terraform)
    runs-on: ubuntu-latest
    permissions: 
      security-events: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: './terraform'
          format: 'sarif'
          output: 'trivy-terraform-results.sarif'
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-terraform-results.sarif'
      
      - name: Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-terraform-report
          path: trivy-terraform-results.sarif