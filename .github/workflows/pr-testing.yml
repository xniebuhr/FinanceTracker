name: PR - Full Testing

# Runs on pull requests targeting main branch
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  # Re-run all CI validations
  run-ci-validations:
    name: Run CI Validations
    uses: ./.github/workflows/ci-validation.yml

  # CONTAINERIZATION - Build Docker Images
  build-containers:
    name: Build Docker Containers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build with Docker Compose
        run: docker compose build
      
      - name: Tag Images
        run: |
          docker tag finance-tracker-backend:latest finance-tracker-backend:pr
          docker tag finance-tracker-frontend:latest finance-tracker-frontend:pr
      
      - name: Save Docker Images
        run: |
          docker save finance-tracker-backend:pr | gzip > backend-image.tar.gz
          docker save finance-tracker-frontend:pr | gzip > frontend-image.tar.gz
      
      - name: Upload Container Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-containers
          path: |
            backend-image.tar.gz
            frontend-image.tar.gz

  # CONTAINER SECURITY SCANNING - Trivy
  container-security-scan:
    name: Container Security - Trivy
    runs-on: ubuntu-latest
    needs: build-container
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Container Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-container
      
      - name: Load Docker Image
        # PLACEHOLDER: docker load < image.tar.gz
        run: echo "Load image placeholder"
      
      - name: Run Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'backend:pr'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-container-results.sarif'
      
      - name: Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-report
          path: trivy-container-results.sarif

#   # INTEGRATION TESTS - Containerized Backend
#   integration-tests:
#     name: Integration Tests
#     runs-on: ubuntu-latest
#     needs: build-containers
#     steps:
#       

#   # E2E TESTS - Cypress
#   e2e-tests:
#     name: E2E Tests - Cypress
#     runs-on: ubuntu-latest
#     needs: build-container
#     steps:
#       

#   # DYNAMIC APPLICATION SECURITY TESTING - OWASP ZAP
#   dast-owasp-zap:
#     name: DAST - OWASP ZAP
#     runs-on: ubuntu-latest
#     needs: build-container
#     steps:
#       

  # PREVIEW CHANGES - Infrastructure & Database
  preview-changes:
    name: Preview Changes - Infrastructure & Database
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Generate EF Migration Bundle
        working-directory: ./backend
        # PLACEHOLDER: dotnet ef migrations bundle (don't apply)
        run: echo "EF migration bundle placeholder"
      
      - name: Terraform Init
        working-directory: ./terraform
        # PLACEHOLDER: terraform init
        run: echo "terraform init placeholder"
      
      - name: Terraform Plan
        working-directory: ./terraform
        # PLACEHOLDER: terraform plan -out=tfplan
        run: echo "terraform plan placeholder"
      
      - name: Comment PR with Changes
        # PLACEHOLDER: Post terraform plan & migration info to PR
        run: echo "PR comment placeholder"
